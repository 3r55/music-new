<!-- TEMPLATE predash -->
<script>
	let time = null;
	let queue = null;
	let lastPte = 0;

	function prettySeconds(seconds) {
		let minutes = Math.floor(seconds / 60);
		seconds = seconds % 60;
		let hours = Math.floor(minutes / 60);
		minutes = minutes % 60;
		let output = [];
		if (hours) {
			output.push(hours);
			output.push(minutes.toString().padStart(2, "0"));
		} else {
			output.push(minutes);
		}
		output.push(seconds.toString().padStart(2, "0"));
		return output.join(":");
	}

	function updatePte() {
		if (typeof(time) == "number" && q("#playTimeElapsed")) {
			q("#playTimeElapsed").innerText = prettySeconds(Math.floor(time/1000));
			q("#totalTime").innerText = queue.songs[0].length;
			//q("#progressBar").style.background = `linear-gradient(to right, #3b88c3 ${percent}%, white ${percent}%)`;
		}
	}

	ws.addEventListener("open", event => {
		wssend({event: "login", token: token, serverID: getGuild()});
	});
	ws.addEventListener("message", event => {
		console.log("Received WS data: "+event.data);
		let data = JSON.parse(event.data);
		if (data.event == "queuesUpdate") {
			queue = data.queue;
			if (!queue || !queue.songs[0]) {
				q("#nothingPlaying").style.display = "block";
				q("#somethingPlaying").style.display = "none";
			} else {
				q("#nothingPlaying").style.display = "none";
				let display = q("#somethingPlaying");
				display.style.display = "block";
				q("#nowPlaying").innerText = "Now playing: "+queue.songs[0].title+(queue.playing ? "" : " (paused)");
				q("#bigThumbnail").src = queue.songs[0].thumbnailLarge;
				time = queue.time || 0;
				lastPte = Date.now();
				updatePte();
				if (queue.songs[0].length != "LIVE") {
					let totalTime = queue.songs[0].length;
					q("#progressLine").style.transition = "none";
					let progressRatio = ((time/1000)/totalTime);
					q("#progressLine").style.transform = `scaleX(${progressRatio})`;
					if (queue.playing && queue.skippable) {
						q("#progressLine").style.transition = `${totalTime-queue.time/1000}s linear`;
						setTimeout(() => {
							q("#progressLine").style.transform = `scaleX(1)`;
						});
					}
				} else {
					q("#progressLine").style.transition = "none";
					q("#progressLine").style.transform = "scaleX(1)";
				}
				if (queue.songs[1]) {
					q("#upNextContainer").style.display = "block";
					q("#upNextEmpty").style.display = "none";
					q("#upNextContainer").innerHTML = "";
					for (let song of queue.songs.slice(1)) {
						let ie = q("#queueItemStorage").children[0].cloneNode(true);
						ie.children[0].children[0].src = song.thumbnailSmall;
						ie.children[1].children[0].innerText = song.title;
						ie.children[1].children[1].innerText = song.author;
						ie.children[1].children[2].innerText = song.length;
						q("#upNextContainer").appendChild(ie);
					}
				} else {
					q("#upNextContainer").style.display = "none";
					q("#upNextEmpty").style.display = "block";
				}
			}
		}
	});

	setInterval(() => {
		if (!queue) return;
		if (!queue.playing || !queue.skippable) return;
		if (typeof(time) != "number") return;
		time += Date.now()-lastPte;
		lastPte = Date.now();
		updatePte();
	}, 1000);

</script>
<!-- TEMPLATE header -->
<div id="nothingPlaying">
	<span class="whitebox aboutbox">
		Nothing is playing.
	</span>
</div>
<div id="somethingPlaying" style="display: none;">
	<div style="display: flex" class="whitebox">
		<div><img id="bigThumbnail"></div>
		<div>
			<div id="nowPlaying"></div>
			<span id="progressContainer">
				<span id="playTimeElapsed">0:00</span>
				<span id="progressBar"><span id="progressLine"></span></span>
				<span id="totalTime">0:00</span>
			</span>
			<div id="buttonControlContainer">
				<button onclick='playPause(queue.playing)'><img src="/images/playpause.svg"></button>
				<button onclick='simpleAPI("skip")'><img src="/images/skip.svg"></button>
				<button onclick='simpleAPI("stop")'><img src="/images/stop.svg"></button>
			</div>
		</div>
	</div>
	<h2>Up next:</h2>
	<div id="upNextContainer"></div>
	<div id="upNextEmpty">
		<p>Nothing here. Queue some songs and they'll be played once the current song ends.</p>
	</div>
</div>
<div id="queueItemStorage">
	<span class="queueItem whitebox">
		<span>
			<img>
		</span>
		<span>
			<div class="queueSongTitle">If you can see this without looking at the code, please contact someone from the <a href="/about">about page</a> with screenshots.</div>
			<div class="queueSongAuthor">However, I'm going to assume that you <em>did</em> find this in the source code.</div>
			<div class="queueSongTime">Please stop looking. There's nothing interesting here.</div>
		</span>
	</span>
</div>
<!-- TEMPLATE end -->